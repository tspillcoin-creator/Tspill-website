<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSPILL — Presale</title>
  <meta name="description" content="TSPILL presale on Solana — SOL settled at USDT value with on-chain claims at TGE." />
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b0f14;color:#e8f0ff}
    header{padding:20px;text-align:center}
    .nav{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border:1px solid #2a3550;border-radius:10px;color:#cfe3ff;text-decoration:none;cursor:pointer;background:#0e1420}
    main{max-width:1000px;margin:24px auto;padding:0 20px}
    h2,h3{margin:8px 0 10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin:16px 0}
    .card{padding:16px;border:1px solid #1c2538;border-radius:14px;background:#0e1420}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="number"],input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #1c2538;background:#0b1220;color:#e8f0ff}
    label{font-size:.95rem;color:#cfe3ff}
    .muted{color:#9fb3d1;font-size:.95rem}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ok{color:#8ee5a1}
    .warn{color:#ffd57a}
    .err{color:#ffa7a7}
  </style>
</head>
<body>
  <header>
    <h1>TSPILL Presale</h1>
    <p class="muted">Buy TSPILL on Solana — USDT value paid in SOL. 10% at TGE, then monthly over 9 months.</p>
    <div class="row" style="justify-content:center">
      <button id="connectBtn" class="btn">Connect Phantom</button>
      <span id="walletBadge" class="muted"></span>
    </div>
  </header>

  <main>
    <section class="card">
      <h3>Presale checkout</h3>
      <div class="grid">
        <div class="card">
          <strong>Enter amount (USDT)</strong>
          <div class="row" style="margin-top:8px">
            <input id="usdtInput" type="number" step="0.01" min="5" placeholder="e.g., 50" />
            <button class="btn" data-q="50">50</button>
            <button class="btn" data-q="100">100</button>
            <button class="btn" data-q="250">250</button>
            <button class="btn" data-q="1000">1000</button>
          </div>
          <p class="muted" style="margin:8px 0 0">Min 5 • Max 1000 (USDT value)</p>

          <div style="margin-top:12px">
            <label for="solOut">Estimated SOL to send</label>
            <input id="solOut" type="text" readonly />
            <p class="muted" id="quoteNote">Quote pending…</p>
          </div>

          <div style="margin-top:12px">
            <label for="tspillOut">You receive (TSPILL)</label>
            <input id="tspillOut" type="text" readonly />
            <p class="muted">Price: 0.001 USDT per TSPILL</p>
          </div>

          <div style="margin-top:12px">
            <button id="sendBtn" class="btn">Send SOL to Presale</button>
            <p id="sendHint" class="muted">Phantom will open to review and sign a SOL transfer.</p>
            <p id="txStatus" class="muted"></p>
          </div>
        </div>

        <div class="card">
          <strong>Details</strong>
          <ul style="margin:8px 0 0 18px">
            <li>Presale allocation: 30% (300,000,000 TSPILL)</li>
            <li>Soft cap: 50,000 USDT • Hard cap: 300,000 USDT</li>
            <li>Per‑wallet: up to 1,000 USDT equivalent in SOL</li>
            <li>Distribution: 10% at TGE, 90% linear over 9 months</li>
          </ul>
          <div style="margin-top:12px">
            <strong>Wallets & mints</strong>
            <p class="mono" style="margin:8px 0 0">Presale treasury (SOL): DgNqpvhNEhEKrc3wUKRccP1S2iUPFgaKbVqik7QmmYTK</p>
            <p class="mono" style="margin:6px 0 0">Admin (dev): BsBpUykVhosqpkQpwVbnoMLyFWT3RxFxiXgpG8kQWY8P</p>
            <p class="mono" style="margin:6px 0 0">TSPILL mint: 2whGdeMMm1E8JJ6cANoNARLNFbayfV2Mixh3WSQUUSbK</p>
          </div>
          <p class="muted" style="margin-top:10px">
            Use Phantom. Do not send from exchange addresses. Quotes are based on a live SOL/USDT feed and valid for a short window.
          </p>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Transparency</h3>
      <ul style="margin:8px 0 0 18px">
        <li>Public read‑only ledger will display total raised (USDT value) and allocations.</li>
        <li>Before TGE, vesting claim parameters will be published for deterministic claims.</li>
        <li>No third‑party custody; funds held in the presale treasury wallet.</li>
      </ul>
    </section>
  </main>

  <!-- Minimal dependencies via CDN -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js" integrity="" crossorigin="anonymous"></script>

  <script>
  ;(function(){
    const treasury = new solanaWeb3.PublicKey("DgNqpvhNEhEKrc3wUKRccP1S2iUPFgaKbVqik7QmmYTK");
    const PRICE_USDT_PER_TSPILL = 0.001;
    const MIN_USDT = 5;
    const MAX_USDT = 1000;

    const connectBtn = document.getElementById('connectBtn');
    const walletBadge = document.getElementById('walletBadge');
    const usdtInput = document.getElementById('usdtInput');
    const solOut = document.getElementById('solOut');
    const tspillOut = document.getElementById('tspillOut');
    const quoteNote = document.getElementById('quoteNote');
    const sendBtn = document.getElementById('sendBtn');
    const txStatus = document.getElementById('txStatus');

    const quickBtns = document.querySelectorAll('button[data-q]');

    let provider = null;      // Phantom provider
    let connection = null;    // RPC connection
    let quote = { solPerUsdt: 0, ts: 0 }; // latest quote

    // Use mainnet public RPC; replace with your own if rate-limited
    const RPC = "https://api.mainnet-beta.solana.com";

    // Basic Phantom detection
    function getProvider() {
      if ('solana' in window) {
        const any = window.solana;
        if (any && any.isPhantom) return any;
      }
      return null;
    }

    async function connect() {
      provider = getProvider();
      if (!provider) {
        walletBadge.textContent = "Phantom not found — install the wallet.";
        return;
      }
      try {
        const resp = await provider.connect();
        walletBadge.textContent = "Connected: " + resp.publicKey.toBase58().slice(0,4) + "…" + resp.publicKey.toBase58().slice(-4);
        connection = new solanaWeb3.Connection(RPC, 'confirmed');
      } catch (e) {
        walletBadge.textContent = "Connect cancelled.";
      }
    }

    connectBtn.addEventListener('click', connect);

    // Quick amount buttons
    quickBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        usdtInput.value = b.getAttribute('data-q');
        recalc();
      });
    });

    // Fetch a SOL/USDT price. For production, integrate a robust feed (e.g., Pyth price service endpoint).
    async function fetchQuote() {
      try {
        // Simple fallback quote via a public API (example). Replace with Pyth/your oracle backend in production.
        const r = await fetch("https://price.jup.ag/v6/price?ids=SOL");
        const j = await r.json();
        const solUsd = j.data.SOL.price; // USD per SOL
        // Assume USDT ~ 1 USD
        quote.solPerUsdt = 1 / solUsd;
        quote.ts = Date.now();
        quoteNote.textContent = "Quote: 1 USDT ≈ " + (quote.solPerUsdt).toFixed(9) + " SOL • updated just now";
      } catch (e) {
        quoteNote.textContent = "Quote unavailable. Retry.";
      }
    }

    async function recalc() {
      const usdt = parseFloat(usdtInput.value || "0");
      if (!isFinite(usdt) || usdt <= 0) {
        solOut.value = "";
        tspillOut.value = "";
        return;
      }
      if (!quote.ts || Date.now() - quote.ts > 30_000) {
        await fetchQuote();
      }
      const solAmt = usdt * quote.solPerUsdt;
      solOut.value = solAmt.toFixed(6) + " SOL";
      const tspill = usdt / PRICE_USDT_PER_TSPILL;
      tspillOut.value = Math.floor(tspill).toLocaleString() + " TSPILL";
      if (usdt < MIN_USDT || usdt > MAX_USDT) {
        quoteNote.textContent = "Amount must be between " + MIN_USDT + " and " + MAX_USDT + " USDT (equivalent).";
      }
    }

    usdtInput.addEventListener('input', recalc);

    // Build and send SOL transfer
    async function sendSol() {
      txStatus.textContent = "";
      const usdt = parseFloat(usdtInput.value || "0");
      if (!provider) { await connect(); if(!provider) return; }
      if (!connection) connection = new solanaWeb3.Connection(RPC, 'confirmed');

      if (!isFinite(usdt) || usdt < MIN_USDT || usdt > MAX_USDT) {
        txStatus.innerHTML = "<span class='warn'>Enter an amount between " + MIN_USDT + " and " + MAX_USDT + " USDT.</span>";
        return;
      }
      if (!quote.ts || Date.now() - quote.ts > 30_000) {
        await fetchQuote();
      }
      if (!quote.solPerUsdt) {
        txStatus.innerHTML = "<span class='err'>Quote unavailable. Try again.</span>";
        return;
      }
      const solAmount = usdt * quote.solPerUsdt;
      const lamports = Math.round(solAmount * solanaWeb3.LAMPORTS_PER_SOL);

      try {
        const fromPubkey = provider.publicKey;
        const tx = new solanaWeb3.Transaction().add(
          solanaWeb3.SystemProgram.transfer({
            fromPubkey,
            toPubkey: treasury,
            lamports
          })
        );
        tx.feePayer = fromPubkey;
        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;

        const signed = await provider.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize(), { skipPreflight:false });
        await connection.confirmTransaction({ signature: sig, blockhash, lastValidBlockHeight: (await connection.getLatestBlockhash()).lastValidBlockHeight }, 'confirmed');

        const tspill = Math.floor(usdt / PRICE_USDT_PER_TSPILL);
        txStatus.innerHTML = "<span class='ok'>Sent.</span> Tx: <span class='mono'>" + sig + "</span><br/>" +
          "Record for ledger — Wallet: <span class='mono'>" + fromPubkey.toBase58() + "</span> • USDT value: " + usdt.toFixed(2) +
          " • SOL: " + (lamports/solanaWeb3.LAMPORTS_PER_SOL).toFixed(6) +
          " • TSPILL: " + tspill.toLocaleString() + ".";

      } catch (e) {
        txStatus.innerHTML = "<span class='err'>Transaction failed or cancelled.</span>";
      }
    }

    sendBtn.addEventListener('click', sendSol);

    // Initial quote
    fetchQuote();
  })();
  </script>
</body>
</html>
