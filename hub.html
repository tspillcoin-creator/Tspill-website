<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSPILL Hub — Stage 3</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#e6d18a;
  font-family:Arial, sans-serif;
  overflow:hidden;
}

 .ledger-watermark {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 96px;
  font-weight: 600;
  letter-spacing: 0.4em;
  text-transform: uppercase;
  color: #f5d67a;
  opacity: 0.035;
  pointer-events: none;
  user-select: none;
  z-index: 1;
  white-space: nowrap;
}

.top-bar{
  position:fixed;
  top:16px;
  right:20px;
  font-size:13px;
  white-space:nowrap;
}

.grid{
  position:absolute;
  top:70px;
  left:0;
  right:0;
  bottom:120px;
  padding:30px;
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(220px,1fr));
  gap:24px;
  overflow-y:auto;
}

.intent-card {
  height: 140px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  border: 1px solid rgba(245,214,122,0.25);
  background: rgba(0,0,0,0.6);
  cursor: pointer;
}

.intent-id {
  font-size: 11px;
  letter-spacing: 0.12em;
  opacity: 0.6;
}

.intent-title {
  font-size: 14px;
  font-weight: 500;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.intent-meta{
  font-size:11px;
  opacity:0.7;
  line-height:1.4;
}
.intent-footer {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  opacity: 0.65;
}

.plus-btn{
  position:fixed;
  bottom:32px;
  left:50%;
  transform:translateX(-50%);
  width:70px;
  height:70px;
  border-radius:50%;
  border:1px solid #e6d18a;
  background:transparent;
  color:#e6d18a;
  font-size:36px;
  cursor:pointer;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-box{
  width:340px;
  border:1px solid #e6d18a;
  padding:20px;
  background:#0b0b0b;
}

.modal-box input,
.modal-box textarea{
  width:100%;
  margin-bottom:10px;
  background:#000;
  border:1px solid #444;
  color:#e6d18a;
  padding:8px;
}

.modal-box button{
  width:100%;
  background:transparent;
  border:1px solid #e6d18a;
  color:#e6d18a;
  padding:8px;
  cursor:pointer;
}

.side-panel {
  position: fixed;
  top: 0;
  right: 0;
  width: 360px;
  height: 100vh;
  background: #0b0b0b;
  color: #f5d67a;
  border-left: 1px solid rgba(245,214,122,0.3);
  z-index: 1001;
  transform: translateX(100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.side-panel.open {
  transform: translateX(0);
}

.side-panel.hidden {
  display: none;
}

.side-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  font-size: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.close-btn {
  background: none;
  border: none;
  color: #f5d67a;
  font-size: 18px;
  cursor: pointer;
}

.side-panel-content {
  padding: 20px;
  font-size: 13px;
  overflow-y: auto;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
}

.overlay.hidden {
  display: none;
}

.execution-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 16px;
}

.panel-label {
  font-size: 12px;
  opacity: 0.8;
}

.execution-section textarea {
  min-height: 80px;
  background: #000;
  border: 1px solid rgba(245,214,122,0.3);
  color: #f5d67a;
  padding: 8px;
}

.panel-save-btn {
  background: transparent;
  border: 1px solid #f5d67a;
  color: #f5d67a;
  padding: 8px;
  cursor: pointer;
}

.image-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 16px;
}

.image-preview img {
  width: 100%;
  max-height: 160px;
  object-fit: contain;
  border: 1px solid rgba(245,214,122,0.3);
  background: #000;
}

.image-preview.hidden {
  display: none;
}
  
.anchor-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 16px;
}

.anchor-section input {
  background: #000;
  border: 1px solid rgba(245,214,122,0.3);
  color: #f5d67a;
  padding: 8px;
}

.readonly-header {
  border-bottom: 1px solid rgba(245,214,122,0.2);
  padding-bottom: 8px;
  margin-bottom: 12px;
}

.anchor-badge {
  font-size: 11px;
  opacity: 0.7;
  border: 1px solid rgba(245,214,122,0.5);
  padding: 2px 6px;
}

.readonly-section {
  margin-top: 14px;
}

.readonly-label {
  font-size: 10px;
  letter-spacing: 0.12em;
  opacity: 0.55;
  margin-bottom: 4px;
  text-transform: uppercase;
}

.readonly-value {
  line-height: 1.4;
  opacity: 0.85;
}

.readonly-image {
  width: 100%;
  max-height: 160px;
  object-fit: contain;
  border: 1px solid rgba(245,214,122,0.25);
  margin-top: 6px;
}

.readonly-link {
  color: #f5d67a;
  text-decoration: none;
  word-break: break-all;
  font-size: 12px;
}

.readonly-footer {
  margin-top: 20px;
  font-size: 11px;
  opacity: 0.6;
  border-top: 1px solid rgba(255,255,255,0.08);
  padding-top: 10px;
}
</style>
</head>

<body>

<div class="ledger-watermark">PUBLIC LEDGER</div>

<div id="sidePanel" class="side-panel hidden">
  <div class="side-panel-header">
    <div id="sidePanelTitle">Intent</div>
    <button class="close-btn" onclick="closeSidePanel()">×</button>
  </div>

  <div class="side-panel-content" id="sidePanelMainContent">
    <p id="sidePanelMeta"></p>

    <div id="editModeControls">
      <div class="execution-section">
        <label class="panel-label">Execution note</label>
        <textarea id="executionNoteInput" placeholder="Describe how you are thinking of executing this intent (optional)"></textarea>
        <button class="panel-save-btn" onclick="saveExecutionNote()">Save execution note</button>
      </div>

      <div class="image-section">
        <label class="panel-label">Intent image (optional)</label>
        <input type="file" id="intentImageInput" accept="image/*" onchange="handleImageUpload(event)" />
        <div id="imagePreview" class="image-preview hidden"></div>
      </div>
        
      <div class="anchor-section">
        <label class="panel-label">Anchor (optional)</label>
        <input type="text" id="anchorInput" placeholder="Reference, link, or execution anchor" />
        <button class="panel-save-btn" onclick="saveAnchor()">Save anchor</button>
      </div>
    </div>

    <div id="readonlyContent" style="display:none;"></div>
  </div>
</div>

<div id="overlay" class="overlay hidden" onclick="closeSidePanel()"></div>
 
<div class="top-bar">
  <span id="creatorLabel"></span> | Status: Entry acknowledged
</div>

<div class="grid" id="grid"></div>

<button class="plus-btn" onclick="openCreateModal()">+</button>

<div class="modal" id="createModal">
  <div class="modal-box">
    <input id="intentTitle" placeholder="Intent title">
    <textarea id="intentDesc" placeholder="Intent description"></textarea>
    <button onclick="createIntent()">Declare Intent</button>
  </div>
</div>

<div class="modal" id="contextModal">
  <div class="modal-box">
    <input id="domain" placeholder="Domain (e.g. Fashion, Art, Technology)">
    <input id="nature" placeholder="Intent nature (e.g. Research, Build, Expression)">
    <textarea id="purpose" placeholder="Context purpose"></textarea>
    <input id="serve" placeholder="Context serve"></textarea>
    <button onclick="saveContext()">Save Context</button>
  </div>
</div>
  
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, query, where, getDocs, addDoc, 
  serverTimestamp, doc, updateDoc, increment, orderBy, limit
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAN7-bKw4_X43PURwp9hXqE5kH4UNXlyTQ",
  authDomain: "tspill-protocol.firebaseapp.com",
  projectId: "tspill-protocol",
  storageBucket: "tspill-protocol.firebasestorage.app",
  messagingSenderId: "863753676409",
  appId: "1:863753676409:web:ae3957d697c68d877556a8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const TSPILL_ID = localStorage.getItem("TSPILL_ID");
if (!TSPILL_ID) { window.location.href = "index.html"; }

window.db = db;
window.TSPILL_ID = TSPILL_ID;
window.updateDoc = updateDoc;
window.doc = doc;
window.increment = increment;
window.serverTimestamp = serverTimestamp;

const creatorLabel = document.getElementById("creatorLabel");
if (creatorLabel) { creatorLabel.textContent = `Creator ID: ${TSPILL_ID}`; }

window.intents = [];

window.saveIntentToFirebase = async function (intentData) {
  try {
    const counterRef = doc(db, "meta", "intentCounter");
    await updateDoc(counterRef, { current: increment(1) });
    const counterSnap = await getDocs(query(collection(db, "meta"), where("__name__", "==", "intentCounter")));
    let count = 1;
    counterSnap.forEach(d => { count = d.data().current; });
    const intentId = "INT-" + String(count).padStart(3, "0");

    const docRef = await addDoc(collection(db, "intents"), {
      ...intentData,
      intentId: intentId,
      creatorId: TSPILL_ID,
      stage: intentData.stage || 1,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    return docRef.id;
  } catch (err) { console.error(err); return null; }
};

window.loadIntentsFromFirebase = async function () {
  try {
    const q = query(collection(db, "intents"), where("creatorId", "==", TSPILL_ID));
    const snapshot = await getDocs(q);
    window.intents = [];
    snapshot.forEach(snap => {
      const data = snap.data();
      window.intents.push({
        ...data,
        id: data.intentId || snap.id,
        _docId: snap.id,
        image: data.imageUrl ? { type: "remote", src: data.imageUrl } : null
      });
    });
    render();
  } catch (err) { console.error(err); }
};

loadIntentsFromFirebase();
</script>

<script>
let activeIntent = null;

function openCreateModal(){ document.getElementById("createModal").style.display = "flex"; }
function closeModals(){ 
    document.getElementById("createModal").style.display = "none"; 
    document.getElementById("contextModal").style.display = "none"; 
}

async function createIntent(){
  const title = document.getElementById("intentTitle").value.trim();
  const desc = document.getElementById("intentDesc").value.trim();
  if(!title || !desc) return;
  await saveIntentToFirebase({ title, description: desc, stage: 2, signals: 0, contextLocked: false });
  await loadIntentsFromFirebase();
  closeModals();
}

function openContextModal(intent){
  activeIntent = intent;
  document.getElementById("contextModal").style.display = "flex";
}

async function saveContext(){
  if(!activeIntent) return;
  const updates = {
    domain: document.getElementById("domain").value.trim(),
    intentNature: document.getElementById("nature").value.trim(),
    contextPurpose: document.getElementById("purpose").value.trim(),
    contextServe: document.getElementById("serve").value.trim(),
    contextLocked: true,
    signals: increment(1),
    stage: 3
  };
  await updateDoc(doc(db, "intents", activeIntent._docId), updates);
  closeModals();
  await loadIntentsFromFirebase();
}

async function openExecutionPath(intentId) {
  const intent = window.intents.find(i => i.id === intentId);
  if (intent && intent.stage === 3 && intent.signals >= 2) {
    await updateDoc(doc(db, "intents", intent._docId), { stage: 4 });
    await loadIntentsFromFirebase();
  }
}

function render(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  window.intents.forEach(intent => {
    const card = document.createElement("div");
    card.className = "intent-card";
    
    if(intent.stage === 3) card.onclick = () => intent.contextLocked ? openExecutionPath(intent.id) : openContextModal(intent);
    if(intent.stage === 4) card.onclick = () => openSidePanel(intent);
    if(intent.stage === 5) card.onclick = () => openReadonlyPanel(intent);

    let stageLabel = intent.stage === 5 ? "Anchored" : (intent.stage === 4 ? "Execution Path" : "Under Observation");

    card.innerHTML = `
      <div class="intent-id">${intent.id}</div>
      <div class="intent-title">${intent.title}</div>
      <div class="intent-meta">${intent.creatorId} | ${stageLabel}</div>
      <div class="intent-footer">
        <span>Signals: ${intent.signals || 0}</span>
        ${intent.stage === 5 ? `<span class="anchor-badge">ANCHOR</span>` : ""}
      </div>
    `;
    grid.appendChild(card);
  });
}

function openSidePanel(intent){
  activeIntent = intent;
  document.getElementById("editModeControls").style.display = "block";
  document.getElementById("readonlyContent").style.display = "none";
  document.getElementById("sidePanelTitle").textContent = intent.id;
  document.getElementById("executionNoteInput").value = intent.executionNote || "";
  document.getElementById("anchorInput").value = intent.anchor || "";
  
  const preview = document.getElementById("imagePreview");
  if(intent.imageUrl || (intent.image && intent.image.src)){
    preview.innerHTML = `<img src="${intent.imageUrl || intent.image.src}" />`;
    preview.classList.remove("hidden");
  } else {
    preview.classList.add("hidden");
  }

  document.getElementById("sidePanel").classList.add("open");
  document.getElementById("sidePanel").classList.remove("hidden");
  document.getElementById("overlay").classList.remove("hidden");
}

async function saveExecutionNote(){
  if(!activeIntent) return;
  const note = document.getElementById("executionNoteInput").value;
  await updateDoc(doc(db, "intents", activeIntent._docId), { executionNote: note });
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file || !activeIntent) return;
  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result;
    await updateDoc(doc(db, "intents", activeIntent._docId), { imageUrl: base64 });
    activeIntent.imageUrl = base64;
    const prev = document.getElementById("imagePreview");
    prev.innerHTML = `<img src="${base64}" />`;
    prev.classList.remove("hidden");
  };
  reader.readAsDataURL(file);
}

async function saveAnchor(){
  const anchor = document.getElementById("anchorInput").value.trim();
  await updateDoc(doc(db, "intents", activeIntent._docId), { 
    anchor: anchor, 
    stage: 5, 
    anchoredAt: serverTimestamp() 
  });
  closeSidePanel();
  await loadIntentsFromFirebase();
}

function openReadonlyPanel(intent){
  activeIntent = intent;
  document.getElementById("editModeControls").style.display = "none";
  document.getElementById("readonlyContent").style.display = "block";
  
  const domain = intent.domain || intent.constraints?.domain || "—";
  const nature = intent.intentNature || intent.constraints?.nature || "—";
  const purpose = intent.contextPurpose || intent.constraints?.purpose || "—";
  const serve = intent.contextServe || intent.constraints?.serve || "—";
  const imgSrc = intent.imageUrl || intent.image?.src;

  document.getElementById("readonlyContent").innerHTML = `
    <div class="readonly-header">
      <div class="intent-id">${intent.id}</div>
      <div class="intent-title">${intent.title}</div>
      <div class="anchor-badge">FINAL ANCHOR</div>
    </div>
    <div class="readonly-section">
      <div class="readonly-label">Description</div>
      <div class="readonly-value">${intent.description}</div>
    </div>
    <div class="readonly-section">
      <div class="readonly-label">Constraints</div>
      <div class="readonly-value">
        <strong>Domain:</strong> ${domain}<br>
        <strong>Nature:</strong> ${nature}<br>
        <strong>Purpose:</strong> ${purpose}<br>
        <strong>Serve:</strong> ${serve}
      </div>
    </div>
    ${imgSrc ? `
      <div class="readonly-section">
        <div class="readonly-label">Artifact</div>
        <img class="readonly-image" src="${imgSrc}" />
      </div>
    ` : ""}
    <div class="readonly-section">
      <div class="readonly-label">Execution Note</div>
      <div class="readonly-value">${intent.executionNote || "—"}</div>
    </div>
    ${intent.anchor ? `
      <div class="readonly-section">
        <div class="readonly-label">Anchor</div>
        <a class="readonly-link" href="${intent.anchor}" target="_blank">${intent.anchor}</a>
      </div>
    ` : ""}
  `;
  
  document.getElementById("sidePanel").classList.add("open");
  document.getElementById("sidePanel").classList.remove("hidden");
  document.getElementById("overlay").classList.remove("hidden");
}

function closeSidePanel(){
  document.getElementById("sidePanel").classList.remove("open");
  setTimeout(() => document.getElementById("sidePanel").classList.add("hidden"), 300);
  document.getElementById("overlay").classList.add("hidden");
}
</script>

</body>
</html>
