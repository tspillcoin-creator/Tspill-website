<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TSPILL Hub Test</title>
<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Inter,system-ui,sans-serif;
  overflow:hidden;
}

#top{
  position:fixed;
  top:20px;
  right:40px;
  font-size:12px;
  letter-spacing:1px;
  color:#d4af37;
  z-index:5;
}

#grid{
  height:100vh;
  padding:120px 80px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:24px;
  overflow-y:auto;
  min-height:100vh;
}

.intent{
  height:120px;
  border:1px solid rgba(255,255,255,.08);
  background:#0b0b0b;
  padding:14px;
  cursor:pointer;
}

.intent:hover{
  border-color:#d4af37;
}

.intent-id{
  font-size:11px;
  color:#aaa;
}

.plus-btn{
  position:fixed;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  width:60px;
  height:60px;
  border-radius:50%;
  border:1px solid #d4af37;
  background:transparent;
  color:#d4af37;
  font-size:28px;
  cursor:pointer;
}

#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}

#modal-box{
  width:360px;
  background:#050505;
  border:1px solid rgba(212,175,55,.3);
  padding:24px;
}

#modal-box input,
#modal-box textarea{
  width:100%;
  background:#000;
  border:1px solid #333;
  color:#fff;
  padding:8px;
  margin-bottom:12px;
}
</style>

</head>

<body>

<div id="top">Creator: <span id="cid"></span> | Status: Active | Signals: 0</div>

<div id="grid"></div>

<button class="plus-btn" onclick="openModal()">+</button>

<div id="modal" onclick="if(event.target.id==='modal')this.style.display='none'">
  <div id="modal-box">
    <h3 style="margin-bottom:12px">Declare Intent</h3>
    <input id="intentTitle" placeholder="Intent title">
    <textarea id="intentDesc" placeholder="Intent description"></textarea>
    <button onclick="addIntent()">Log Intent</button>
  </div>
</div>

</body>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  console.log("JS RUNNING");

  const cid = localStorage.getItem("TSPILL_ID");
  if(!cid){
    alert("No ID, returning to gate");
    location.href="index.html";
  }

  document.getElementById("cid").textContent = cid;
  render();
});

let intents=[];
let intentCounter = 0;

function render(){
  const g = document.getElementById("grid");
  g.innerHTML = "";

  if(intents.length === 0){
    g.innerHTML = "No intents yet.";
    return;
  }

  intents.forEach((i, idx) => {

    evaluateStage(i);   // stage engine heartbeat

    const d = document.createElement("div");
    d.className = "intent";

    d.innerHTML = `
      <div class="intent-id">
        ${i.id}
      </div>
      <div style="font-size:11px; opacity:.7; margin-top:6px;">
        Stage: ${stageLabel(i.stage)}
      </div>
      <div style="font-size:11px; opacity:.6;">
        Signals: ${i.signals}
      </div>
    `;

    g.appendChild(d);
  });
}

function openModal(){
  console.log("PLUS CLICKED");
  document.getElementById("modal").style.display="block";
}

function addIntent(){
  const title = document.getElementById("intentTitle").value.trim();
  const desc  = document.getElementById("intentDesc").value.trim();
  if(!title || !desc) return;

  intentCounter++;

  intents.push({
    id: "INT-" + intentCounter.toString().padStart(3,"0"),
    title,
    desc,
    stage: 0,
    signals: 0,
    signalLog: [],
    createdAt: Date.now(),
    locked: false
  });

  document.getElementById("intentTitle").value="";
  document.getElementById("intentDesc").value="";
  document.getElementById("modal").style.display="none";

  render();
}
function stageLabel(stage){
  return [
    "Declared",
    "Logged",
    "Under Observation",
    "External Interest Detected",
    "Execution Path Open",
    "Archived"
  ][stage] || "Unknown";
}
function evaluateStage(intent){
  let progressed = true;

  while(progressed){
    progressed = false;
    const now = Date.now();
    const age = now - intent.createdAt;

    if(intent.stage === 0){
      intent.stage = 1;
      progressed = true;
    }
    else if(intent.stage === 1 && age > 3000){
      intent.stage = 2;
      progressed = true;
    }
    else if(intent.stage === 2 && intent.signals > 0){
      intent.stage = 3;
      progressed = true;
    }
    else if(intent.stage === 3 && intent.signals >= 3){
      intent.stage = 4;
      progressed = true;
    }
  }
}

  function registerExternalSignal(intentId){
  const intent = intents.find(i => i.id === intentId);
  if(!intent){
    console.warn("Intent not found:", intentId);
    return;
  }

  intent.signals++;

  // Resolve stage immediately
  evaluateStage(intent);

  // Refresh UI
  render();
}

</script>

</body>
</html>
